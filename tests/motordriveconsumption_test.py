#!/usr/bin/env python3
import unittest

# This adapts sys.path to include all relevant packages
import context

# our own packages
from base import TestSystemCalcBase
from delegates import MotorDriveConsumption

# Testing tools
from mock_gobject import timer_manager

# Monkey patching for unit tests
import patches

import math


class MotorDriveConsumptionTest(TestSystemCalcBase):

	def setUp(self):
		TestSystemCalcBase.setUp(self)
		self._monitor._tree.setdefault('com.victronenergy.system', {"/GpsService": None})
		self._monitor.add_service('com.victronenergy.system', {"/GpsService": None})
		self._motordriveconsumption = next(
			x
			for x in self._system_calc._modules
			if isinstance(x, MotorDriveConsumption)
		)

	def _addMotorDrive(self):
		self._add_device(
			"com.victronenergy.motordrive.ttyX1",
			product_name="ACME Motor Drive",
			values={
				"/Dc/0/Voltage": 24,
				"/Dc/0/Current": 10,
				"/Dc/0/Power": 240,
				"/Motor/RPM": 1000,
				"/DeviceInstance": 1,
			},
		)

	def _removeMotorDrive(self):
		self._remove_device("com.victronenergy.motordrive.ttyX1")

	def _addGps(self):
		self._add_device(
			"com.victronenergy.gps.ttyX2",
			product_name="ACME Gps",
			values={
				"/DeviceInstance": 2,
				"/Speed": 0,
				"/UtcTime": 0,
				"/Position/Latitude": 0.0,
				"/Position/Longitude": 0.0,
				"/Fix": 1,
			},
		)

	def _removeGps(self):
		self._remove_device("com.victronenergy.gps.ttyX2")

	def destination_point(self, lat, lon, distance, bearing):
		R = 6371000
		lat1 = math.radians(lat)
		lon1 = math.radians(lon)
		bearing = math.radians(bearing)
		delta = distance / R
		lat2 = math.asin(
			math.sin(lat1) * math.cos(delta)
			+ math.cos(lat1) * math.sin(delta) * math.cos(bearing)
		)
		lon2 = lon1 + math.atan2(
			math.sin(bearing) * math.sin(delta) * math.cos(lat1),
			math.cos(delta) - math.sin(lat1) * math.sin(lat2),
		)
		lat2 = math.degrees(lat2)
		lon2 = math.degrees(lon2)
		return lat2, lon2

	def simulate_steps(self, steps):
		last_latitude = 0.0
		last_longitude = 0.0
		last_time = 0

		# t = 0s
		self._monitor.set_value("com.victronenergy.gps.ttyX2", "/UtcTime", 0)
		self._monitor.set_value(
			"com.victronenergy.gps.ttyX2", "/Position/Latitude", last_latitude
		)
		self._monitor.set_value(
			"com.victronenergy.gps.ttyX2", "/Position/Longitude", last_longitude
		)
		self._service["/MotorDrive/Power"] = None
		timer_manager.run(0)

		for step in steps:
			time_step = step[0]
			distance = step[1]
			bearing = step[2]
			power = step[3]

			# t + time_step s
			new_latitude, new_longitude = self.destination_point(
				last_latitude, last_longitude, distance, bearing
			)
			new_time = last_time + time_step

			self._monitor.set_value("com.victronenergy.gps.ttyX2", "/UtcTime", new_time)
			self._monitor.set_value(
				"com.victronenergy.gps.ttyX2", "/Position/Latitude", new_latitude
			)
			self._monitor.set_value(
				"com.victronenergy.gps.ttyX2", "/Position/Longitude", new_longitude
			)
			self._service["/MotorDrive/Power"] = power
			timer_manager.run(0)

			last_latitude = new_latitude
			last_longitude = new_longitude
			last_time = new_time

	def test_basic(self):
		self._addGps()
		self._addMotorDrive()
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)

		# MockDbusService does not update values in DbusMonitor automatically
		# so we need to set it manually
		self._monitor.set_value(
			"com.victronenergy.system", "/GpsService", "com.victronenergy.gps.ttyX2"
		)

		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)
		self.simulate_steps(
			[
				[60000, 100, 45, 1000],  # going ~3.2knots at 1000W for 1km in 10m
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
			]
		)
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": 166.66666666666663,  # Wh/km
			}
		)

	def test_too_slow(self):
		self._addGps()
		self._addMotorDrive()
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)

		# MockDbusService does not update values in DbusMonitor automatically
		# so we need to set it manually
		self._monitor.set_value(
			"com.victronenergy.system", "/GpsService", "com.victronenergy.gps.ttyX2"
		)

		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)
		self.simulate_steps(
			[
				[60000, 100, 45, 1000],  # going ~3.2knots at 1000W for 1km in 10m
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[1000, 0.2, 45, 1000], # below minimum speed, should be ignored
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
			]
		)
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": 166.66666666666663,  # Wh/km
			}
		)

	def test_too_fast(self):
		self._addGps()
		self._addMotorDrive()
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)

		# MockDbusService does not update values in DbusMonitor automatically
		# so we need to set it manually
		self._monitor.set_value(
			"com.victronenergy.system", "/GpsService", "com.victronenergy.gps.ttyX2"
		)

		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)
		self.simulate_steps(
			[
				[60000, 100, 45, 1000],  # going ~3.2knots at 1000W for 1km in 10m
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 1300, 45, 20000], # above maximum speed, should be clamped
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
			]
		)
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": 239.09107369183417,  # Wh/km
			}
		)

	def test_bearing_turn_too_quick(self):
		self._addGps()
		self._addMotorDrive()
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)

		# MockDbusService does not update values in DbusMonitor automatically
		# so we need to set it manually
		self._monitor.set_value(
			"com.victronenergy.system", "/GpsService", "com.victronenergy.gps.ttyX2"
		)

		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": None,
			}
		)
		self.simulate_steps(
			[
				[60000, 100, 45, 1000],  # going ~3.2knots at 1000W for 1km in 10m
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[1000, 10, 200, 1000], # above bearing change threshold, should be ignored
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
				[60000, 100, 45, 1000],
			]
		)
		self._update_values()
		self._check_values(
			{
				"/GpsService": "com.victronenergy.gps.ttyX2",
				"/MotorDrive/Consumption": 166.66666666666663,  # Wh/km
			}
		)
